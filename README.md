# 掲載状況確認アプリ

各ふるさと納税ポータルサイトからダウンロードしたCSV/Excelデータを取り込み、指定した基準日における返礼品の掲載ステータス（公開中、非表示、在庫切れ、期間外など）を判定・一覧化するStreamlitアプリケーションです。

## 📖 概要

このアプリは、複数のポータルサイトの管理画面から出力される異なるフォーマットのデータを読み込み、統一された基準でステータス判定を行います。
「楽天」「さとふる」「ふるなび」などの主要ポータルに対応しており、各サイトの掲載期間や在庫数を横断的にチェックすることが可能です。

## ✨ 主な機能

### 1. 対応ポータル
以下のポータルサイトのデータ取り込みに対応しています。（2025年12月時点）

| No. | ポータル名 | No. | ポータル名 |
|:---:|:---|:---:|:---|
| 1 | チョイス | 8 | プレミアム |
| 2 | 楽天 | 9 | JRE |
| 3 | JAL | 10 | さとふる |
| 4 | ふるなび | 11 | Amazon |
| 5 | ANA | 12 | 百選 |
| 6 | まいふる | 13 | ぐるなび |
| 7 | マイナビ | 14 | あとギフ |

### 2. ステータス自動判定
掲載期間（開始・終了）、在庫数、各種フラグ（公開/非公開）を基に、以下のステータスを自動計算します。

| ステータス | 判定概要 |
|:---|:---|
| **未登録** | ファイルに該当の返礼品コードが存在しない |
| **非表示** | ポータル側で非公開・非表示設定になっている |
| **倉庫** | 倉庫設定になっている（楽天のみ） |
| **在庫0** | 在庫数が0になっている |
| **注文不可** | 注文ボタンが無効化されている（楽天のみ） |
| **未受付** | 掲載開始日が未来の日付になっている |
| **受付終了** | 掲載終了日が過去の日付になっている |
| **公開中** | 期間内かつ在庫があり、公開設定されている状態 |

* **Googleスプレッドシート連携**:
    * 定期便DB、事業者DBなどのマスタデータをGoogleスプレッドシートから参照します。
* **データフィルタリング**:
    * 返礼品コード、事業者コードでの絞り込みインポート
    * 全文検索、事業者別、ステータス別、定期便フラグでの表示フィルタリング
* **エクスポート**:
    * 判定結果を Excel または CSV 形式でダウンロード可能（色分け等の書式設定付き）。

## 🛠️ 必要要件

* Python 3.8+
* Streamlit
* Pandas
* Google API Client Libraries
* XlsxWriter

## 🚀 セットアップ手順

### 1. リポジトリのクローン
```bash
git clone <repository-url>
cd <repository-directory>
```

### 2. ライブラリのインストール
必要なライブラリをインストールします。
```bash
pip install streamlit pandas numpy google-api-python-client google-auth xlsxwriter openpyxl
```

### 3. Google認証情報の設定 (.streamlit/secrets.toml)
本アプリはGoogleスプレッドシートへアクセスするためにGoogle Service Accountを使用します。
プロジェクトルートに `.streamlit` フォルダを作成し、その中に `secrets.toml` ファイルを作成して以下の形式で認証情報を記述してください。

```toml
[gcp_service_account]
credentials_json = """
{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "your-private-key-id",
  "private_key": "-----BEGIN PRIVATE KEY-----\\n...\\n-----END PRIVATE KEY-----\\n",
  "client_email": "your-service-account@your-project.iam.gserviceaccount.com",
  "client_id": "...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "..."
}
"""
```
※ JSONの中身は、GCPコンソールからダウンロードしたService Accountのキー(JSON)の中身をそのまま貼り付けてください。

### 4. 外部CSSの配置
`style.css` が `app.py` と同じディレクトリに存在することを確認してください。

## ▶️ アプリの起動

以下のコマンドでアプリを起動します。

```bash
streamlit run app.py
```

ブラウザが自動的に開き、アプリが表示されます（デフォルトポート: 8501）。

## 📂 使用方法

1.  **Googleログイン**:
    * アプリ起動後、Googleアカウントでのログインボタンが表示される場合はログインを行います。
2.  **ファイルのアップロード**:
    * サイドバーのアップローダーから、各ポータルのCSV/Excelファイルをアップロードします。
    * **注意**: ファイル名には必ずポータル名を含めてください（例: `楽天_商品データ.csv`, `さとふる_商品.csv`）。
    * ※「チョイス」「さとふる」「百選」は、商品データと在庫データの2ファイルをセットでアップロードする必要があります。
3.  **ベースポータルの選択**:
    * 比較の基準となる「ベースポータル」を選択します。
4.  **基準日の設定**:
    * ステータス判定の基準となる日付を選択します（デフォルトは本日）。
5.  **実行**:
    * 「掲載状況を表示」ボタンをクリックします。
6.  **確認・出力**:
    * メイン画面に判定結果一覧が表示されます。フィルタリング機能を使ってデータを絞り込み、Excel/CSVでダウンロードできます。

## ⚠️ 注意事項

* **ファイル名**: ファイル読み込み時にファイル名からポータルを自動判別しています。ファイル名に特定のキーワード（`楽天`, `チョイス`, `さとふる` など）が含まれていない場合、読み込みがスキップされます。
* **スプレッドシートの権限**: 設定したService Accountのメールアドレスに対し、参照先のスプレッドシート（DB）の共有権限（閲覧または編集）が付与されている必要があります。

## 📁 ディレクトリ構成

```
.
├── app.py                # メインアプリケーションロジック
├── status.py             # 各ポータルのステータス判定ロジック
├── operation_manual.py   # 操作マニュアル表示用モジュール
├── status_manual.py      # ステータス定義表示用モジュール
├── style.css             # アプリのスタイル定義
└── .streamlit/
    └── secrets.toml      # 認証情報（Git管理外）
```
