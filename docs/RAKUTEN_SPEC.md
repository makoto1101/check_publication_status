# 楽天仕様書

本ドキュメントは、「掲載状況確認アプリ」における楽天データ（CSV）の取り込み処理、正規化、およびステータス判定ロジックの詳細仕様について記述します。

楽天データは「SKU移行後」のフォーマットを前提としており、**親子関係（商品管理番号）とSKU（システム連携用SKU番号）** の関係性を整理した上で、掲載ステータスを判定します。
対応文字コードは `Shift-JIS (cp932)` および `UTF-8` です。

## 1. データ取り込みと前処理フロー (`app.py`)

CSV読み込みから、判定用の「代表データ」を作成するまでのプロセスです。

### 1-1. 必須列の検証
CSV読み込み時、以下の列が存在しない場合はエラーとして処理を中断します。

| カテゴリ | 必須列名 | 用途 |
|:---|:---|:---|
| **基本情報** | `商品管理番号（商品URL）` | 親子関係のグルーピングキー |
| | `商品番号` | デフォルトの識別コード |
| | `商品名` | 表示用名称 |
| **制御フラグ** | `倉庫指定` | 0:通常 / 1:倉庫 |
| | `サーチ表示` | 1:表示 / 0:非表示 |
| | `注文ボタン` | 1:可 / 0:不可 |
| **期間** | `販売期間指定（開始日時）` | - |
| | `販売期間指定（終了日時）` | - |
| **SKU情報** | `システム連携用SKU番号` | **真の返礼品コード**として使用 |
| | `SKU倉庫指定` | SKU単位の倉庫フラグ |
| | `在庫数` | - |

※ `SKU管理番号` 列は使用しません。

### 1-2. 親情報の補完（Fill-down）
SKU行（子）では、親商品（1行目）の情報が空欄になっている場合があるため、以下の処理でデータを埋めます。

* **グルーピングキー**: `商品管理番号（商品URL）`
* **処理**: 同一グループ内の **先頭行（親）** の値を、同グループ内の全行（子）にコピーします。
* **補完対象列**: `商品名`, `サーチ表示`, `販売期間指定（開始日時）`, `販売期間指定（終了日時）`, `注文ボタン`

### 1-3. 親子関係の識別と親コード生成
SKU移行に伴い、**「管理用としての親行」** と **「実体としてのSKU行（子）」** を区別します。

1. **グループ行数の判定**:
   `商品管理番号（商品URL）` でグルーピングし、その行数が **3行以上** あるかを確認します。
   * ※ 2行（親1行+子1行など）の場合は、親と子が実質同一とみなせるケースが多いため、この処理は行いません。

2. **親コードの生成**:
   3行以上のグループの **先頭行** に対し、`商品番号` の末尾に **「（楽天親）」** という識別子（サフィックス）を付与します。
   * 例: `ABC001` ⇒ `ABC001（楽天親）`
   * この処理により、親行はユニークなIDを持つ独立したデータとして扱われます。

### 1-4. データの正規化（SKU情報のマージ）
SKU単位で出力される行情報を、メインの判定列に統合（上書き）します。これにより、SKU行を独立した1つの返礼品として扱えるようにします。

1. **商品番号の統合**:
   * `システム連携用SKU番号` に値がある場合 ⇒ **`商品番号` 列をこの値で上書き**します。
   * ※ 親判定された行（1-3で処理済み）は通常SKU番号を持たないため、この上書きの影響を受けず、親コードのまま維持されます。
   * 結果として、**「親コード」と「子コード（SKU）」が別の返礼品コードとして共存**することになります。

2. **倉庫指定の統合**:
   * `SKU倉庫指定` に値がある場合 ⇒ **`倉庫指定` 列をこの値で上書き**します。

### 1-5. 重複排除と代表行の選定
1つの返礼品コード（正規化後の `商品番号`）に対し、複数の行が存在する場合、**「最も販売中である可能性が高い有効な1行」** を残すためにソートを行います。

**ソート順序（優先順位）**

以下の順序でデータを並べ替え、**最上位の1行**を採用します。

| 順位 | 判定項目 | 並び順 | 意図 |
|:---:|:---|:---|:---|
| **1** | **SKU有無** | - | `システム連携用SKU番号`を持つ行を最優先 |
| **2** | **倉庫指定** | **昇順** (0優先) | `1`(倉庫) よりも `0`(通常販売) を優先 |
| **3** | **サーチ表示** | **降順** (1優先) | `0`(非表示) よりも `1`(表示) を優先 |
| **4** | **注文ボタン** | **降順** (1優先) | `0`(不可) よりも `1`(可) を優先 |
| **5** | **販売開始日** | **昇順** (空・過去優先) | ①空欄（常時）<br>②過去日付（開始済）<br>③未来日付（未開始）<br>の順で優先 |
| **6** | **販売終了日** | **昇順** (空・未来優先) | ①空欄（無期限）<br>②未来日付（販売中）<br>③過去日付（終了済）<br>の順で優先 |
| **7** | **在庫数** | **降順** (多い順) | 在庫が多い行を優先 |

※ ソート実行後、`商品番号` で `drop_duplicates(keep='first')` を実行します。
※ この時点で「親コード」と「子コード」は別IDであるため、それぞれが独立して1行ずつ残ります。

---

## 2. ステータス判定ロジック (`status.py`)

前処理で抽出された各行に対し、ステータスを判定します。

### 2-1. 親子重複時の表示制御
「親コード」と「子コード」が両方存在する場合、情報の重複を避けるため、以下のルールで表示を制御します。

* **子コード（SKU）が存在する場合**:
  * 他ポータル（チョイス等）のステータス表示は、**子コード側の行**に集約します。
  * 親コード側の行における他ポータルのステータスは、**「-」（ハイフン）** として抑制します。
* **親コードのみ存在する場合**:
  * 親コード側の行にすべてのステータスを表示します。

### 2-2. 判定フローチャート（楽天ステータス）

1. **未登録判定**: 親コード（`商品管理番号`）が特定できない場合 ⇒ **「未登録」**

2. **倉庫判定**:
   * 自身の `倉庫指定` が `1` の場合 ⇒ **「倉庫」**
   * **【フォールバック】**
     * 同一グループの行数が **2行（ペア）の場合に限り**、相方の行の `倉庫指定` が `1` なら「倉庫」とみなします。
     * ※3行以上の場合は自身の値のみで判定します。

3. **在庫判定**:
   * 自身の `在庫数` が `0` の場合:
     * **【フォールバック】**
       * 同一グループの行数が **2行（ペア）の場合に限り**、相方の行に在庫があればそれを採用します。
       * 相方にも在庫がない、または3行以上の場合は ⇒ **「在庫0」**

4. **非表示判定**: `サーチ表示` が `0` の場合 ⇒ **「非表示」**

5. **注文不可判定**: `注文ボタン` が `0` の場合 ⇒ **「注文不可」**

6. **期間判定**:
   * **基準日について**: アプリで指定された基準日（当日）を含んで判定します。
   * 開始・終了なし ⇒ **「公開中」**
   * 開始日が未来（基準日より後） ⇒ **「未受付」**
   * 終了日が過去（基準日より前） ⇒ **「受付終了」**
   * それ以外（期間内、または基準日が開始日/終了日と一致） ⇒ **「公開中」**

---

## 補足：チョイスの親子仕様

チョイスデータにおいても、楽天同様に親子関係の判定を行っています。

* **判定ロジック**:
  * **A列**: お礼の品ID（自分自身のID）
  * **CW列**: 親お礼の品ID（親商品のID）
  * **判定**: A列の値が、他の行のCW列（親ID）として参照されている場合、その行を「親」とみなします。
* **親コード生成**:
  * 親と判定された行の `返礼品コード`（102列目）の末尾に **「（チョイス親）」** を付与します。
* **表示制御**:
  * 楽天と同様に、子コードが存在する場合は、親行の他ポータルステータス表示を抑制します。